#!/bin/bash

# Set Azure MySQL Flexible Server details
DB_HOST="sqlserver001.mysql.database.azure.com"
DB_USER="test"
DB_PASS="test@2020"
DB_NAME="testdb"

# Define table names
TEMP_TABLE="outage_details_temp"
PROD_TABLE="outage_details_prod"
DELETE_TABLE="outage_details_to_be_deleted"

# Step 1: Drop the old Table "_to_be_deleted" table
echo "Dropping old table $DELETE_TABLE if it exists..."
mysql --ssl -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" <<EOF
DROP TABLE IF EXISTS $DELETE_TABLE;
EOF
echo "Old table $DELETE_TABLE dropped."
sleep 5

# Step 2: Create a new _temp table
echo "Creating new table $TEMP_TABLE..."
mysql --ssl -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" <<EOF
CREATE TABLE $TEMP_TABLE (
    isvc VARCHAR(15) DEFAULT NULL,
    address VARCHAR(70) DEFAULT NULL,
    city VARCHAR(25) DEFAULT NULL,
    zip_code VARCHAR(10) DEFAULT NULL,
    circuit_name VARCHAR(30) DEFAULT NULL,
    status VARCHAR(15) DEFAULT NULL,
    estimated_ert VARCHAR(50) DEFAULT NULL,
    last_updated VARCHAR(50) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
EOF
echo "Table $TEMP_TABLE created successfully."
sleep 5

# Step 3: Ask for the file name
read -p "Enter the CSV file name (including extension): " FILE_NAME

# Define paths
SRC_PATH="/home/b92465e6-60f6-424b-b127-6eae84bd/$FILE_NAME"
DEST_PATH="/home/b92465e6-60f6-424b-b127-6eae84bd/SQL/filcopy/$FILE_NAME"

# Check if file exists
if [ ! -f "$SRC_PATH" ]; then
    echo "Error: File '$FILE_NAME' not found!"
    exit 1
fi

# Copy file from /mnt/data to /home
cp "$SRC_PATH" "$DEST_PATH"

if [ $? -eq 0 ]; then
    echo "File copied to /home successfully."
else
    echo "File copy failed."
    exit 1
fi
sleep 5

# Change file permissions
chmod 777 "$DEST_PATH"
echo "File permissions updated to 777."
sleep 5

# Step 4: Import Data into _temp table
echo "Uploading file to table $TEMP_TABLE..."
mysql --ssl -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" <<EOF
LOAD DATA LOCAL INFILE '$DEST_PATH'
INTO TABLE $TEMP_TABLE
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
IGNORE 1 LINES;
EOF
echo "File uploaded to table $TEMP_TABLE."
sleep 5

# Step 5: Add Indexes to All Columns in _temp table
echo "Adding indexes to $TEMP_TABLE..."
mysql --ssl -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" <<EOF
ALTER TABLE $TEMP_TABLE 
ADD INDEX idx_isvc (isvc),
ADD INDEX idx_address (address),
ADD INDEX idx_city (city),
ADD INDEX idx_zip_code (zip_code),
ADD INDEX idx_circuit_name (circuit_name),
ADD INDEX idx_status (status),
ADD INDEX idx_estimated_ert (estimated_ert),
ADD INDEX idx_last_updated (last_updated);
EOF
echo "Indexes added successfully."
sleep 5

# Step 6: Rename _prod table to _to_be_deleted
echo "Renaming $PROD_TABLE to $DELETE_TABLE..."
mysql --ssl -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" <<EOF
RENAME TABLE $PROD_TABLE TO $DELETE_TABLE;
EOF
echo "Table $PROD_TABLE renamed to $DELETE_TABLE."
sleep 5

# Step 7: Rename _temp table to _prod
echo "Renaming $TEMP_TABLE to $PROD_TABLE..."
mysql --ssl -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" <<EOF
RENAME TABLE $TEMP_TABLE TO $PROD_TABLE;
EOF
echo "Table $TEMP_TABLE renamed to $PROD_TABLE successfully."
sleep 5

echo "All tasks completed successfully!"